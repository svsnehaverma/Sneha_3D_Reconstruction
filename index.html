<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SfM — Minimal (Multi‑image)</title>
<style>
  html,body{margin:0;padding:0;background:#111;color:#eee;font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:980px;margin:0 auto;padding:12px}
  h1{font-size:18px;margin:6px 0 12px}
  .credit{font-size:12px;color:#aaa}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .box{flex:1 1 300px;border:1px solid #2a2a2a;border-radius:8px;padding:10px;background:#171717}
  .dz{border:2px dashed #3b3b3b;border-radius:8px;padding:8px;text-align:center}
  .dz.drag{background:#202020}
  .btn{appearance:none;border:1px solid #2a2a2a;background:#222;color:#eee;border-radius:8px;padding:8px 10px;cursor:pointer}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  #ref{width:100%;height:240px;object-fit:cover;border-radius:6px;background:#000;margin-top:8px}
  #view3d{width:100%;height:420px;border:1px solid #2a2a2a;border-radius:8px;background:#000}
  label{font-weight:600;font-size:13px}
  .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(72px,1fr));gap:6px;margin-top:6px;max-height:160px;overflow:auto}
  .thumbs img{width:100%;height:60px;object-fit:cover;border:1px solid #2a2a2a;border-radius:6px;cursor:pointer;opacity:.85}
  .thumbs img.active{outline:2px solid #4c9cff;opacity:1}
</style>
<script defer src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script defer src="https://unpkg.com/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
<div class="wrap">
  <h1>SfM — Minimal Demo (Multi‑image) <span class="credit" style="float:right">Developed by Newcastle University</span></h1>

  <div class="row">
    <div class="box">
      <label>1) 3D Source (drop first)</label>
      <div id="dz1" class="dz">Drop image here or <input id="f1" type="file" accept="image/*"></div>
      <div style="height:6px"></div>
      <label>2) Reference Photos (drop multiple)</label>
      <div id="dz2" class="dz">Drop images here or <input id="f2" type="file" accept="image/*" multiple></div>
      <img id="ref" alt="reference preview"/>
      <div id="thumbs" class="thumbs"></div>
      <div style="height:8px"></div>
      <button id="go" class="btn" disabled>Build 3D Preview</button>
      <button id="reset" class="btn">Reset</button>
    </div>

    <div class="box" style="flex:2 1 500px">
      <label>3D Preview</label>
      <div id="view3d"></div>
    </div>
  </div>
</div>

<script>
  const dz1=document.getElementById('dz1'); const dz2=document.getElementById('dz2');
  const f1=document.getElementById('f1'); const f2=document.getElementById('f2');
  const go=document.getElementById('go'); const resetBtn=document.getElementById('reset');
  const ref=document.getElementById('ref'); const thumbs=document.getElementById('thumbs');
  const state={src1:null, refs:[], active:0};

  function readFile(file){return new Promise((res,rej)=>{const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file);});}
  function setupDrop(el,cb){ el.addEventListener('dragover',e=>{e.preventDefault(); el.classList.add('drag');}); el.addEventListener('dragleave',()=>el.classList.remove('drag')); el.addEventListener('drop',async e=>{e.preventDefault(); el.classList.remove('drag'); const list=e.dataTransfer.files||[]; await cb(list);}); }

  setupDrop(dz1, async (files)=>{ const f=files[0]; if(f&&f.type.startsWith('image/')){ state.src1=await readFile(f);} go.disabled=!(state.src1&&state.refs.length); });
  setupDrop(dz2, async (files)=>{ for(const f of files){ if(f.type?.startsWith('image/')) state.refs.push(await readFile(f)); } if(state.refs.length){ state.active=state.refs.length-1; ref.src=state.refs[state.active]; } renderThumbs(); go.disabled=!(state.src1&&state.refs.length); });

  f1.addEventListener('change', async()=>{ if(f1.files[0]){ state.src1=await readFile(f1.files[0]); go.disabled=!(state.src1&&state.refs.length);} });
  f2.addEventListener('change', async()=>{ if(!f2.files.length) return; for(const file of f2.files){ if(file.type.startsWith('image/')){ state.refs.push(await readFile(file)); } } state.active=state.refs.length-1; ref.src=state.refs[state.active]; renderThumbs(); go.disabled=!(state.src1&&state.refs.length); });
  resetBtn.addEventListener('click', ()=>location.reload());

  function renderThumbs(){ thumbs.innerHTML=''; state.refs.forEach((u,i)=>{ const im=document.createElement('img'); im.src=u; im.title=`Reference ${i+1}`; if(i===state.active) im.classList.add('active'); im.onclick=()=>{ state.active=i; ref.src=state.refs[state.active]; updatePlane(); renderThumbs(); }; thumbs.appendChild(im); }); }

  // Three.js minimal viewer
  let renderer, scene, camera, controls, cloud, plane;
  function init3D(){ const host=document.getElementById('view3d'); const w=host.clientWidth,h=host.clientHeight; renderer=new THREE.WebGLRenderer({antialias:true}); renderer.setSize(w,h); host.innerHTML=''; host.appendChild(renderer.domElement); scene=new THREE.Scene(); scene.background=new THREE.Color(0x000000); camera=new THREE.PerspectiveCamera(50,w/h,1,5000); camera.position.set(0,180,800); controls=new THREE.OrbitControls(camera,renderer.domElement); scene.add(new THREE.AmbientLight(0xffffff,0.7)); const d=new THREE.DirectionalLight(0xffffff,0.6); d.position.set(1,1,1); scene.add(d); const animate=()=>{requestAnimationFrame(animate); controls.update(); renderer.render(scene,camera);}; animate(); }

  function makeCloud(points){ const g=new THREE.BufferGeometry(); const pos=new Float32Array(points.length*3); const col=new Float32Array(points.length*3); for(let i=0;i<points.length;i++){ const p=points[i]; pos[i*3]=p.x; pos[i*3+1]=p.y; pos[i*3+2]=p.z; col[i*3]=p.r/255; col[i*3+1]=p.g/255; col[i*3+2]=p.b/255; } g.setAttribute('position', new THREE.BufferAttribute(pos,3)); g.setAttribute('color', new THREE.BufferAttribute(col,3)); return new THREE.Points(g, new THREE.PointsMaterial({size:2,vertexColors:true})); }

  function imageToPoints(url, step=6, zScale=0.7){ return new Promise(res=>{ const img=new Image(); img.onload=()=>{ const c=document.createElement('canvas'), x=c.getContext('2d'); const w=img.width,h=img.height,max=960,s=Math.min(1,max/Math.max(w,h)); const W=Math.round(w*s),H=Math.round(h*s); c.width=W;c.height=H; x.drawImage(img,0,0,W,H); const d=x.getImageData(0,0,W,H).data; const pts=[]; for(let y=0;y<H;y+=step){ for(let x0=0;x0<W;x0+=step){ const i=(y*W+x0)*4; const r=d[i],g=d[i+1],b=d[i+2]; const br=(0.299*r+0.587*g+0.114*b)/255; const X=x0-W/2, Y=H/2-y, Z=(br-0.5)*(W+H)/2*zScale; pts.push({x:X,y:Y,z:Z,r,g,b}); }} res(pts); }; img.src=url; }); }

  async function build(){ if(!state.src1) return; const pts=await imageToPoints(state.src1,5,0.8); if(cloud) scene.remove(cloud); cloud=makeCloud(pts); scene.add(cloud); updatePlane(); }
  function updatePlane(){ if(plane){ scene.remove(plane); plane.geometry.dispose(); plane.material.dispose(); } if(state.refs.length){ const tex=new THREE.TextureLoader().load(state.refs[state.active]); plane=new THREE.Mesh(new THREE.PlaneGeometry(600,360), new THREE.MeshBasicMaterial({map:tex, side:THREE.DoubleSide})); plane.position.set(-380,60,-80); plane.rotation.y=-0.2; scene.add(plane);} }

  document.getElementById('go').addEventListener('click', build);
  window.addEventListener('load', init3D);
</script>
</body>
</html>

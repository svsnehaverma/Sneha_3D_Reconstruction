<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SfM Demo — Newcastle University (Simple)</title>
  <style>
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0b1020;color:#e9eeff}
    header{padding:12px 16px;border-bottom:1px solid #1b2555;display:flex;align-items:center;gap:10px}
    header h1{font-size:16px;margin:0}
    main{display:grid;grid-template-columns:360px 1fr;gap:12px;padding:12px}
    .card{background:#12183a;border:1px solid #1b2555;border-radius:12px}
    .card h2{margin:0;padding:10px 12px;border-bottom:1px solid #1b2555;font-size:14px}
    .body{padding:12px}
    .dz{border:2px dashed #2f3da0;border-radius:10px;padding:12px;text-align:center;color:#b8c2ff}
    .dz.drag{background:#0f1748}
    .thumb{margin-top:10px;border:1px solid #2a378e;border-radius:10px;overflow:hidden}
    .thumb img{display:block;width:100%;height:260px;object-fit:cover}
    button{background:#4d77ff;border:0;color:#fff;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    .row{display:flex;gap:12px}
    .viewer{background:black;border-radius:12px;border:1px solid #1b2555;height:520px;position:relative}
    .note{position:absolute;bottom:8px;left:10px;color:#a7b2ff;font-size:12px}
    .bar{display:flex;gap:8px;align-items:center;margin-top:10px}
  </style>
  <script defer src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script defer src="https://unpkg.com/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
  <header>
    <h1>Structure‑from‑Motion — Simple Web Preview</h1>
    <div style="margin-left:auto;font-size:12px;color:#bcd">Developed by Newcastle University</div>
  </header>

  <main>
    <section class="card">
      <h2>Images</h2>
      <div class="body">
        <div id="dz1" class="dz">Drop <b>3D source</b> image here (first) or <input id="f1" type="file" accept="image/*"></div>
        <div id="dz2" class="dz" style="margin-top:10px">Drop <b>reference</b> photo here (second) or <input id="f2" type="file" accept="image/*"></div>
        <div id="thumb" class="thumb" style="display:none"><img id="refImg" alt="Reference"></div>
        <div class="bar">
          <button id="go" disabled>Build 3D Preview</button>
          <button id="reset" class="secondary" style="background:#1b234c;border:1px solid #2a388a">Reset</button>
        </div>
        <p style="font-size:12px;color:#b8c2ff;margin-top:6px">How it works: the first image becomes a quick **point‑cloud style** 3D preview; the second image is displayed as the photo beside it and as a board in the 3D scene.</p>
      </div>
    </section>

    <section class="card">
      <h2>Preview</h2>
      <div class="body">
        <div class="row">
          <div style="width:340px">
            <div class="viewer" style="height:240px">
              <img id="leftImg" alt="Reference preview" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:12px"/>
              <div class="note">Reference photo (second)</div>
            </div>
          </div>
          <div class="viewer" id="view3d" style="flex:1">
            <div class="note">3D point cloud (from first image)</div>
          </div>
        </div>
      </div>
    </section>
  </main>

<script>
  const dz1 = document.getElementById('dz1');
  const dz2 = document.getElementById('dz2');
  const f1 = document.getElementById('f1');
  const f2 = document.getElementById('f2');
  const go = document.getElementById('go');
  const resetBtn = document.getElementById('reset');
  const leftImg = document.getElementById('leftImg');
  const thumbWrap = document.getElementById('thumb');
  const refImg = document.getElementById('refImg');

  const state = { src1:null, src2:null };

  function readFile(file){
    return new Promise((res,rej)=>{const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file);});
  }

  function setupDrop(el, cb){
    el.addEventListener('dragover', e=>{e.preventDefault(); el.classList.add('drag');});
    el.addEventListener('dragleave', ()=>el.classList.remove('drag'));
    el.addEventListener('drop', async e=>{e.preventDefault(); el.classList.remove('drag'); const f=e.dataTransfer.files?.[0]; if(f&&f.type.startsWith('image/')) cb(await readFile(f));});
  }

  setupDrop(dz1, (src)=>{ state.src1 = src; go.disabled = !(state.src1 && state.src2); });
  setupDrop(dz2, (src)=>{ state.src2 = src; leftImg.src = src; refImg.src = src; thumbWrap.style.display='block'; go.disabled = !(state.src1 && state.src2); });
  f1.addEventListener('change', async ()=>{ if(f1.files[0]){ state.src1 = await readFile(f1.files[0]); go.disabled = !(state.src1 && state.src2); }});
  f2.addEventListener('change', async ()=>{ if(f2.files[0]){ state.src2 = await readFile(f2.files[0]); leftImg.src = state.src2; refImg.src = state.src2; thumbWrap.style.display='block'; go.disabled = !(state.src1 && state.src2); }});
  resetBtn.addEventListener('click', ()=>{ location.reload(); });

  // --- THREE viewer ---
  let renderer, scene, camera, controls, cloud, plane;
  function initThree(){
    const host = document.getElementById('view3d');
    const w = host.clientWidth, h = host.clientHeight;
    renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(w,h); host.innerHTML=''; host.appendChild(renderer.domElement);
    scene = new THREE.Scene(); scene.background = new THREE.Color(0x000000);
    camera = new THREE.PerspectiveCamera(50, w/h, 1, 5000); camera.position.set(0,200,900);
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    scene.add(new THREE.AmbientLight(0xffffff,0.6)); const d=new THREE.DirectionalLight(0xffffff,0.6); d.position.set(1,1,1); scene.add(d);
    const grid=new THREE.GridHelper(1200,24,0x444444,0x222222); grid.position.y=-300; scene.add(grid);
    const animate=()=>{ requestAnimationFrame(animate); controls.update(); renderer.render(scene,camera); }; animate();
  }

  function makeCloud(points){
    const g=new THREE.BufferGeometry();
    const pos=new Float32Array(points.length*3);
    const col=new Float32Array(points.length*3);
    for(let i=0;i<points.length;i++){
      const p=points[i]; pos[i*3]=p.x; pos[i*3+1]=p.y; pos[i*3+2]=p.z; col[i*3]=p.r/255; col[i*3+1]=p.g/255; col[i*3+2]=p.b/255;
    }
    g.setAttribute('position', new THREE.BufferAttribute(pos,3));
    g.setAttribute('color', new THREE.BufferAttribute(col,3));
    const m=new THREE.PointsMaterial({size:2.2, vertexColors:true});
    return new THREE.Points(g,m);
  }

  async function buildPreview(){
    if(!state.src1) return;
    // quick depth-from-brightness preview
    const pts = await imageToPoints(state.src1, 5, 0.8);
    if(cloud) scene.remove(cloud);
    cloud = makeCloud(pts); scene.add(cloud);
    // add the reference image as a board
    if(plane) scene.remove(plane);
    if(state.src2){
      const tex = new THREE.TextureLoader().load(state.src2);
      plane = new THREE.Mesh(new THREE.PlaneGeometry(600, 360), new THREE.MeshBasicMaterial({map:tex, side:THREE.DoubleSide}));
      plane.position.set(-420,80,-80); plane.rotation.y = -0.2; scene.add(plane);
    }
  }

  function imageToPoints(dataUrl, step=6, zScale=0.7){
    return new Promise(res=>{
      const img=new Image(); img.onload=()=>{
        const c=document.createElement('canvas'); const x=c.getContext('2d');
        const w=img.width, h=img.height; const max=960; const s=Math.min(1, max/Math.max(w,h));
        const W=Math.round(w*s), H=Math.round(h*s); c.width=W; c.height=H; x.drawImage(img,0,0,W,H);
        const d=x.getImageData(0,0,W,H).data; const out=[];
        for(let y=0;y<H;y+=step){ for(let x0=0;x0<W;x0+=step){ const i=(y*W+x0)*4; const r=d[i], g=d[i+1], b=d[i+2]; const br=(0.299*r+0.587*g+0.114*b)/255; const X=x0-W/2; const Y=H/2-y; const Z=(br-0.5)*(W+H)/2*zScale; out.push({x:X,y:Y,z:Z,r,g,b}); } }
        res(out);
      }; img.src=dataUrl;
    });
  }

  document.getElementById('go').addEventListener('click', buildPreview);
  window.addEventListener('load', ()=>{ initThree(); });
</script>
</body>
</html>

import React, { useCallback, useEffect, useRef, useState } from "react";import { Card, CardContent } from "@/components/ui/card";import { Button } from "@/components/ui/button";import { Input } from "@/components/ui/input";import { Progress } from "@/components/ui/progress";import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";import { Badge } from "@/components/ui/badge";import { Loader2, ImagePlus, UploadCloud, PlayCircle, Camera, Info, Download, RotateCcw, GraduationCap, Image as ImageIcon } from "lucide-react";import * as THREE from "three";import { OrbitControls } from "three/examples/jsm/controls/OrbitControls.js";// --- utils ---function readAsDataURL(file) {  return new Promise((resolve, reject) => {    const reader = new FileReader();    reader.onload = () => resolve(reader.result);    reader.onerror = reject;    reader.readAsDataURL(file);  });}// Export a simple PLY string from point cloud [{x,y,z,r,g,b}]function exportPLY(points) {  let header = `plyformat ascii 1.0` +    `element vertex ${points.length}` +    `property float xproperty float yproperty float zproperty uchar redproperty uchar greenproperty uchar blueend_header`;  const body = points.map(p => `${p.x} ${p.y} ${p.z} ${p.r} ${p.g} ${p.b}`).join("");  return header + body + "";}// Build a quick pseudo-3D from an image: a relief based on brightness (instant demo)async function quickReliefPointCloudFromImage(imgDataUrl, sampleStep = 6, zScale = 0.7) {  return new Promise((resolve) => {    const img = new Image();    img.onload = () => {      const canvas = document.createElement("canvas");      const ctx = canvas.getContext("2d");      const w = img.width, h = img.height;      const maxSide = 960;      let scale = 1;      if (Math.max(w, h) > maxSide) scale = maxSide / Math.max(w, h);      const W = Math.round(w * scale), H = Math.round(h * scale);      canvas.width = W; canvas.height = H;      ctx.drawImage(img, 0, 0, W, H);      const { data } = ctx.getImageData(0, 0, W, H);      const points = [];      for (let y = 0; y < H; y += sampleStep) {        for (let x = 0; x < W; x += sampleStep) {          const i = (y * W + x) * 4;          const r = data[i], g = data[i+1], b = data[i+2];          const brightness = (0.299*r + 0.587*g + 0.114*b) / 255;          const X = (x - W/2);          const Y = (H/2 - y);          const Z = (brightness - 0.5) * (W+H)/2 * zScale;          points.push({ x: X, y: Y, z: Z, r, g, b });        }      }      resolve(points);    };    img.src = imgDataUrl;  });}// ---- 3D Viewer ----function PointCloudViewer({ points, texturedPlaneDataUrl, onDropTexture }) {  const mountRef = useRef(null);  const meshRef = useRef(null);  const planeRef = useRef(null);  useEffect(() => {    const mount = mountRef.current;    const scene = new THREE.Scene();    scene.background = new THREE.Color(0x0b1220);    const renderer = new THREE.WebGLRenderer({ antialias: true });    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));    renderer.setSize(mount.clientWidth, mount.clientHeight);    mount.appendChild(renderer.domElement);    const camera = new THREE.PerspectiveCamera(45, mount.clientWidth / mount.clientHeight, 1, 10000);    camera.position.set(0, 120, 900);    const controls = new OrbitControls(camera, renderer.domElement);    controls.enableDamping = true;    const light = new THREE.DirectionalLight(0xffffff, 0.85);    light.position.set(1, 1, 1);    scene.add(light);    scene.add(new THREE.AmbientLight(0xffffff, 0.4));    const grid = new THREE.GridHelper(1400, 30, 0x444444, 0x222222);    grid.position.y = -320;    scene.add(grid);    const axes = new THREE.AxesHelper(160);    axes.material.transparent = true; axes.material.opacity = 0.6;    scene.add(axes);    // reference image plane (will update texture when user drops an image)    const tex = texturedPlaneDataUrl ? new THREE.TextureLoader().load(texturedPlaneDataUrl) : null;    const plane = new THREE.Mesh(      new THREE.PlaneGeometry(600, 360),      new THREE.MeshBasicMaterial({ map: tex, color: tex ? 0xffffff : 0x888888, side: THREE.DoubleSide })    );    plane.position.set(-420, 60, -80);    plane.rotation.y = Math.PI * -0.12;    scene.add(plane);    planeRef.current = plane;    // initial cloud (empty, will be set below or via effect)    const geometry = new THREE.BufferGeometry();    const material = new THREE.PointsMaterial({ size: 2.5, vertexColors: true });    const pointsMesh = new THREE.Points(geometry, material);    scene.add(pointsMesh);    meshRef.current = pointsMesh;    const onResize = () => {      renderer.setSize(mount.clientWidth, mount.clientHeight);      camera.aspect = mount.clientWidth / mount.clientHeight;      camera.updateProjectionMatrix();    };    window.addEventListener("resize", onResize);    // Drag & drop onto viewer to change the reference texture quickly    const prevent = (e) => { e.preventDefault(); };    const handleDrop = async (e) => {      e.preventDefault();      const f = e.dataTransfer.files?.[0];      if (f && f.type.startsWith("image/")) {        const url = await readAsDataURL(f);        if (onDropTexture) onDropTexture(url);      }    };    mount.addEventListener('dragover', prevent);    mount.addEventListener('drop', handleDrop);    const animate = () => { controls.update(); renderer.render(scene, camera); requestAnimationFrame(animate); };    animate();    return () => {      window.removeEventListener("resize", onResize);      mount.removeEventListener('dragover', prevent);      mount.removeEventListener('drop', handleDrop);      renderer.dispose();      mount.removeChild(renderer.domElement);      scene.clear();    };  }, []);  // update cloud  useEffect(() => {    if (!meshRef.current) return;    const geometry = new THREE.BufferGeometry();    if (points && points.length) {      const positions = new Float32Array(points.length * 3);      const colors = new Float32Array(points.length * 3);      for (let i = 0; i < points.length; i++) {        const p = points[i];        positions[i*3] = p.x; positions[i*3+1] = p.y; positions[i*3+2] = p.z;        colors[i*3] = p.r/255; colors[i*3+1] = p.g/255; colors[i*3+2] = p.b/255;      }      geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));      geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));    }    meshRef.current.geometry.dispose();    meshRef.current.geometry = geometry;  }, [points]);  // update texture plane  useEffect(() => {    if (!planeRef.current) return;    if (!texturedPlaneDataUrl) { planeRef.current.material.map = null; planeRef.current.material.color.set(0x888888); planeRef.current.material.needsUpdate = true; return; }    const loader = new THREE.TextureLoader();    loader.load(texturedPlaneDataUrl, (tex) => {      planeRef.current.material.map = tex;      planeRef.current.material.color.set(0xffffff);      planeRef.current.material.needsUpdate = true;    });  }, [texturedPlaneDataUrl]);  return (    <div ref={mountRef} className="w-full h-[560px] rounded-2xl border border-white/10" title="Drop a photo here to update the reference image"/>  );}export default function App() {  const [images, setImages] = useState([]); // all selected image dataURLs (keep order)  const [referenceImg, setReferenceImg] = useState(""); // shown on the big left preview & as texture plane  const [points, setPoints] = useState([]);  const [busy, setBusy] = useState(false);  const [progress, setProgress] = useState(0);  const [downloadHref, setDownloadHref] = useState("");  const handleFiles = useCallback(async (list) => {    const arr = Array.from(list || []).filter(f => f.type.startsWith("image/"));    if (!arr.length) return;    const urls = await Promise.all(arr.map(readAsDataURL));    setImages(urls);    // UX: first picked image is treated as 3D source; last picked is shown as reference panel    setReferenceImg(urls[urls.length - 1]);    setPoints([]); setDownloadHref(""); setProgress(0);  }, []);  const onDropGlobal = useCallback((e) => { e.preventDefault(); if (e.dataTransfer.files?.length) handleFiles(e.dataTransfer.files); }, [handleFiles]);  useEffect(() => { const f=(e)=>e.preventDefault(); window.addEventListener("dragover", f); window.addEventListener("drop", f); return ()=>{window.removeEventListener("dragover", f); window.removeEventListener("drop", f);} }, []);  const generateQuick3D = useCallback(async () => {    if (!images.length) return;    setBusy(true); setProgress(10);    // Treat the FIRST image as the 3D reconstruction source (your point‑cloud screenshot)    const pts = await quickReliefPointCloudFromImage(images[0], 5, 0.8);    setProgress(75);    setPoints(pts);    const ply = exportPLY(pts);    const blob = new Blob([ply], { type: 'text/plain' });    setDownloadHref(URL.createObjectURL(blob));    setProgress(100); setBusy(false);  }, [images]);  const resetAll = () => { setImages([]); setReferenceImg(""); setPoints([]); setDownloadHref(""); setProgress(0); };  // convenience: allow dropping a new texture directly into the 3D viewer  const handleDropTexture = (url) => { setReferenceImg(url); };  return (    <div onDrop={onDropGlobal} className="min-h-screen bg-gradient-to-b from-slate-900 via-slate-950 to-black text-slate-100">      <header className="sticky top-0 z-20 backdrop-blur bg-slate-900/60 border-b border-white/10">        <div className="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">          <div className="flex items-center gap-3">            <div className="w-10 h-10 rounded-xl bg-indigo-600/90 flex items-center justify-center shadow-lg shadow-indigo-600/40">              <GraduationCap className="w-6 h-6" />            </div>            <div>              <h1 className="text-xl font-semibold">Structure‑from‑Motion (SfM) — Professional Web Demo</h1>              <p className="text-xs text-slate-400">Developed by Newcastle University • Robinson Library example</p><!DOCTYPE html><html lang="en"><head>  <meta charset="utf-8" />  <meta name="viewport" content="width=device-width, initial-scale=1" />  <title>SfM Demo — Newcastle University (Simple)</title>  <style>    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0b1020;color:#e9eeff}    header{padding:12px 16px;border-bottom:1px solid #1b2555;display:flex;align-items:center;gap:10px}    header h1{font-size:16px;margin:0}    main{display:grid;grid-template-columns:360px 1fr;gap:12px;padding:12px}    .card{background:#12183a;border:1px solid #1b2555;border-radius:12px}    .card h2{margin:0;padding:10px 12px;border-bottom:1px solid #1b2555;font-size:14px}    .body{padding:12px}    .dz{border:2px dashed #2f3da0;border-radius:10px;padding:12px;text-align:center;color:#b8c2ff}    .dz.drag{background:#0f1748}    .thumb{margin-top:10px;border:1px solid #2a378e;border-radius:10px;overflow:hidden}    .thumb img{display:block;width:100%;height:260px;object-fit:cover}    button{background:#4d77ff;border:0;color:#fff;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}    button:disabled{opacity:.5;cursor:not-allowed}    .row{display:flex;gap:12px}    .viewer{background:black;border-radius:12px;border:1px solid #1b2555;height:520px;position:relative}    .note{position:absolute;bottom:8px;left:10px;color:#a7b2ff;font-size:12px}    .bar{display:flex;gap:8px;align-items:center;margin-top:10px}  </style>  <script defer src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>  <script defer src="https://unpkg.com/three@0.160.0/examples/js/controls/OrbitControls.js"></script></head><body>  <header>    <h1>Structure‑from‑Motion — Simple Web Preview</h1>    <div style="margin-left:auto;font-size:12px;color:#bcd">Developed by Newcastle University</div>  </header>  <main>    <section class="card">      <h2>Images</h2>      <div class="body">        <div id="dz1" class="dz">Drop <b>3D source</b> image here (first) or <input id="f1" type="file" accept="image/*"></div>        <div id="dz2" class="dz" style="margin-top:10px">Drop <b>reference</b> photo here (second) or <input id="f2" type="file" accept="image/*"></div>        <div id="thumb" class="thumb" style="display:none"><img id="refImg" alt="Reference"></div>        <div class="bar">          <button id="go" disabled>Build 3D Preview</button>          <button id="reset" class="secondary" style="background:#1b234c;border:1px solid #2a388a">Reset</button>        </div>        <p style="font-size:12px;color:#b8c2ff;margin-top:6px">How it works: the first image becomes a quick **point‑cloud style** 3D preview; the second image is displayed as the photo beside it and as a board in the 3D scene.</p>      </div>    </section>    <section class="card">      <h2>Preview</h2>      <div class="body">        <div class="row">          <div style="width:340px">            <div class="viewer" style="height:240px">              <img id="leftImg" alt="Reference preview" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:12px"/>              <div class="note">Reference photo (second)</div>            </div>          </div>          <Badge variant="outline" className="bg-white/5">Beta demo</Badge>        </div>      </header>      <main className="max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 xl:grid-cols-3 gap-6">        {/* LEFT: Reference image panel (looks like the second screenshot) */}        <div className="xl:col-span-1 space-y-4">          <Card className="bg-white/5 border-white/10 overflow-hidden">            <CardContent className="p-0">              <div className="flex items-center justify-between px-4 py-3 border-b border-white/10">                <div className="flex items-center gap-2"><ImageIcon className="w-4 h-4"/><span className="font-medium">Reference Image (displayed on screen)</span></div>                <span className="text-xs text-slate-400">Drop an image here or in the viewer</span>              </div>              <label className="block group relative cursor-pointer">                <Input type="file" accept="image/*" multiple onChange={(e)=>handleFiles(e.target.files)} className="hidden" />                <div className="h-[360px] bg-black grid place-items-center">                  {referenceImg ? (                    <img src={referenceImg} alt="reference" className="max-h-[360px] w-full object-cover"/>                  ) : (                    <div className="text-center text-slate-400">                      <UploadCloud className="w-10 h-10 mx-auto mb-2"/>                      <p>Drag & drop the campus facade image (e.g., Robinson Library)</p>                      <p className="text-xs text-slate-500">This will be shown beside the 3D reconstruction</p>                    </div>                  )}                </div>              </label>            </CardContent>          </Card>          <Card className="bg-white/5 border-white/10">            <CardContent className="p-4 space-y-4">              <h2 className="text-lg font-semibold flex items-center gap-2"><Camera className="w-5 h-5"/> Upload images</h2>              <div className="rounded-2xl border border-dashed border-white/20 bg-white/5 p-4 text-center flex flex-col items-center gap-3">                <UploadCloud className="w-8 h-8 text-slate-300"/>                <p className="text-sm text-slate-300">Drop your files anywhere on the page</p>                <p className="text-xs text-slate-500">Order matters: <b>1st</b> = 3D source (point‑cloud screenshot), <b>last</b> = reference photo</p>                <label className="inline-flex items-center gap-2 cursor-pointer">                  <Input type="file" accept="image/*" multiple onChange={(e)=>handleFiles(e.target.files)} className="hidden" />                  <span className="px-3 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 transition text-sm flex items-center gap-2"><ImagePlus className="w-4 h-4"/> Browse</span>                </label>              </div>              {images.length > 0 && (                <div>                  <div className="flex items-center justify-between mb-2">                    <h3 className="text-sm font-medium">Selected ({images.length})</h3>                    <Button variant="ghost" size="sm" onClick={resetAll} className="text-slate-300 hover:text-white"><RotateCcw className="w-4 h-4 mr-1"/>Reset</Button>                  </div>                  <div className="grid grid-cols-4 gap-2 max-h-40 overflow-auto pr-1">                    {images.map((src, idx) => (                      <img key={idx} src={src} alt={`img-${idx}`} className={`w-full h-20 object-cover rounded-lg border ${idx===0? 'border-green-500/70' : 'border-white/10'}`} title={idx===0? '3D source' : 'reference / extra'} />                    ))}                  </div>                </div>              )}              <div className="pt-1 flex items-center gap-2">                <Button onClick={generateQuick3D} disabled={!images.length || busy} className="gap-2">                  {busy ? <Loader2 className="w-4 h-4 animate-spin"/> : <PlayCircle className="w-4 h-4"/>}                  Build 3D Preview                </Button>                {downloadHref && (                  <a href={downloadHref} download="preview_pointcloud.ply" className="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-sm flex items-center gap-2 border border-white/10">                    <Download className="w-4 h-4"/> PLY                  </a>                )}              </div>              {busy && (                <div className="pt-1">                  <Progress value={progress} className="h-2" />                  <p className="text-xs text-slate-400 mt-2">Processing… (client‑side demo)</p>                </div>              )}              <Alert className="bg-indigo-950/60 border-indigo-500/30">                <AlertTitle className="flex items-center gap-2"><Info className="w-4 h-4"/> Professional mode</AlertTitle>                <AlertDescription className="text-sm text-slate-300">                  For a true SfM pipeline (feature matching, pose estimation, bundle adjustment, multi‑view, dense MVS), connect this UI to a backend such as <span className="font-semibold">COLMAP/OpenSfM</span> and stream reconstructed points/meshes into the viewer.                </AlertDescription>              </Alert>            </CardContent>          </Card>          <div class="viewer" id="view3d" style="flex:1">            <div class="note">3D point cloud (from first image)</div>          </div>        </div>      </div>    </section>  </main><script>  const dz1 = document.getElementById('dz1');  const dz2 = document.getElementById('dz2');  const f1 = document.getElementById('f1');  const f2 = document.getElementById('f2');  const go = document.getElementById('go');  const resetBtn = document.getElementById('reset');  const leftImg = document.getElementById('leftImg');  const thumbWrap = document.getElementById('thumb');  const refImg = document.getElementById('refImg');  const state = { src1:null, src2:null };  function readFile(file){    return new Promise((res,rej)=>{const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file);});  }  function setupDrop(el, cb){    el.addEventListener('dragover', e=>{e.preventDefault(); el.classList.add('drag');});    el.addEventListener('dragleave', ()=>el.classList.remove('drag'));    el.addEventListener('drop', async e=>{e.preventDefault(); el.classList.remove('drag'); const f=e.dataTransfer.files?.[0]; if(f&&f.type.startsWith('image/')) cb(await readFile(f));});  }  setupDrop(dz1, (src)=>{ state.src1 = src; go.disabled = !(state.src1 && state.src2); });  setupDrop(dz2, (src)=>{ state.src2 = src; leftImg.src = src; refImg.src = src; thumbWrap.style.display='block'; go.disabled = !(state.src1 && state.src2); });  f1.addEventListener('change', async ()=>{ if(f1.files[0]){ state.src1 = await readFile(f1.files[0]); go.disabled = !(state.src1 && state.src2); }});  f2.addEventListener('change', async ()=>{ if(f2.files[0]){ state.src2 = await readFile(f2.files[0]); leftImg.src = state.src2; refImg.src = state.src2; thumbWrap.style.display='block'; go.disabled = !(state.src1 && state.src2); }});  resetBtn.addEventListener('click', ()=>{ location.reload(); });  // --- THREE viewer ---  let renderer, scene, camera, controls, cloud, plane;  function initThree(){    const host = document.getElementById('view3d');    const w = host.clientWidth, h = host.clientHeight;    renderer = new THREE.WebGLRenderer({antialias:true});    renderer.setSize(w,h); host.innerHTML=''; host.appendChild(renderer.domElement);    scene = new THREE.Scene(); scene.background = new THREE.Color(0x000000);    camera = new THREE.PerspectiveCamera(50, w/h, 1, 5000); camera.position.set(0,200,900);    controls = new THREE.OrbitControls(camera, renderer.domElement);    scene.add(new THREE.AmbientLight(0xffffff,0.6)); const d=new THREE.DirectionalLight(0xffffff,0.6); d.position.set(1,1,1); scene.add(d);    const grid=new THREE.GridHelper(1200,24,0x444444,0x222222); grid.position.y=-300; scene.add(grid);    const animate=()=>{ requestAnimationFrame(animate); controls.update(); renderer.render(scene,camera); }; animate();  }  function makeCloud(points){    const g=new THREE.BufferGeometry();    const pos=new Float32Array(points.length*3);    const col=new Float32Array(points.length*3);    for(let i=0;i<points.length;i++){      const p=points[i]; pos[i*3]=p.x; pos[i*3+1]=p.y; pos[i*3+2]=p.z; col[i*3]=p.r/255; col[i*3+1]=p.g/255; col[i*3+2]=p.b/255;    }    g.setAttribute('position', new THREE.BufferAttribute(pos,3));    g.setAttribute('color', new THREE.BufferAttribute(col,3));    const m=new THREE.PointsMaterial({size:2.2, vertexColors:true});    return new THREE.Points(g,m);  }  async function buildPreview(){    if(!state.src1) return;    // quick depth-from-brightness preview    const pts = await imageToPoints(state.src1, 5, 0.8);    if(cloud) scene.remove(cloud);    cloud = makeCloud(pts); scene.add(cloud);    // add the reference image as a board    if(plane) scene.remove(plane);    if(state.src2){      const tex = new THREE.TextureLoader().load(state.src2);      plane = new THREE.Mesh(new THREE.PlaneGeometry(600, 360), new THREE.MeshBasicMaterial({map:tex, side:THREE.DoubleSide}));      plane.position.set(-420,80,-80); plane.rotation.y = -0.2; scene.add(plane);    }  }  function imageToPoints(dataUrl, step=6, zScale=0.7){    return new Promise(res=>{      const img=new Image(); img.onload=()=>{        const c=document.createElement('canvas'); const x=c.getContext('2d');        const w=img.width, h=img.height; const max=960; const s=Math.min(1, max/Math.max(w,h));        const W=Math.round(w*s), H=Math.round(h*s); c.width=W; c.height=H; x.drawImage(img,0,0,W,H);        const d=x.getImageData(0,0,W,H).data; const out=[];        for(let y=0;y<H;y+=step){ for(let x0=0;x0<W;x0+=step){ const i=(y*W+x0)*4; const r=d[i], g=d[i+1], b=d[i+2]; const br=(0.299*r+0.587*g+0.114*b)/255; const X=x0-W/2; const Y=H/2-y; const Z=(br-0.5)*(W+H)/2*zScale; out.push({x:X,y:Y,z:Z,r,g,b}); } }        res(out);      }; img.src=dataUrl;    });  }        {/* RIGHT: 3D viewer */}        <div className="xl:col-span-2 space-y-4">          <Card className="bg-white/5 border-white/10">            <CardContent className="p-0">              <div className="p-4 border-b border-white/10 flex items-center justify-between">                <div>                  <h2 className="text-lg font-semibold">SfM 3D Reconstruction — Presentation View</h2>                  <p className="text-xs text-slate-400">Tip: Drop the <em>facade photo</em> directly onto the viewer to update the side reference.</p>                </div>                {points?.length ? (                  <Badge className="bg-green-700/60 border border-green-500/50">Point Cloud: {points.length.toLocaleString()} pts</Badge>                ) : (                  <Badge variant="outline" className="bg-white/5">No point cloud</Badge>                )}              </div>              <div className="p-3">                <PointCloudViewer points={points} texturedPlaneDataUrl={referenceImg} onDropTexture={handleDropTexture} />              </div>            </CardContent>          </Card>          <p className="text-xs text-slate-400 text-center">            © {new Date().getFullYear()} Newcastle University — School of Computing. Built by Dr. Sneha Verma & collaborators.          </p>        </div>      </main>    </div>  );}  document.getElementById('go').addEventListener('click', buildPreview);  window.addEventListener('load', ()=>{ initThree(); });</script></body></html>
0 commit commentsComments0 (0)Lock conversationCommentSubscribeYou're not receiving notifications from this thread.<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SfM — Minimal (Multi‑image)</title>
<style>
  html,body{margin:0;padding:0;background:#111;color:#eee;font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:980px;margin:0 auto;padding:12px}
  h1{font-size:18px;margin:6px 0 12px}
  .credit{font-size:12px;color:#aaa}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .box{flex:1 1 300px;border:1px solid #2a2a2a;border-radius:8px;padding:10px;background:#171717}
  .dz{border:2px dashed #3b3b3b;border-radius:8px;padding:8px;text-align:center}
  .dz.drag{background:#202020}
  .btn{appearance:none;border:1px solid #2a2a2a;background:#222;color:#eee;border-radius:8px;padding:8px 10px;cursor:pointer}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  #ref{width:100%;height:240px;object-fit:cover;border-radius:6px;background:#000;margin-top:8px}
  #view3d{width:100%;height:420px;border:1px solid #2a2a2a;border-radius:8px;background:#000}
  label{font-weight:600;font-size:13px}
  .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(72px,1fr));gap:6px;margin-top:6px;max-height:160px;overflow:auto}
  .thumbs img{width:100%;height:60px;object-fit:cover;border:1px solid #2a2a2a;border-radius:6px;cursor:pointer;opacity:.85}
  .thumbs img.active{outline:2px solid #4c9cff;opacity:1}
</style>
<script defer src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script defer src="https://unpkg.com/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
<div class="wrap">
  <h1>SfM — Minimal Demo (Multi‑image) <span class="credit" style="float:right">Developed by Newcastle University</span></h1>

  <div class="row">
    <div class="box">
      <label>1) 3D Source (drop first)</label>
      <div id="dz1" class="dz">Drop image here or <input id="f1" type="file" accept="image/*"></div>
      <div style="height:6px"></div>
      <label>2) Reference Photos (drop multiple)</label>
      <div id="dz2" class="dz">Drop images here or <input id="f2" type="file" accept="image/*" multiple></div>
      <img id="ref" alt="reference preview"/>
      <div id="thumbs" class="thumbs"></div>
      <div style="height:8px"></div>
      <button id="go" class="btn" disabled>Build 3D Preview</button>
      <button id="reset" class="btn">Reset</button>
    </div>

    <div class="box" style="flex:2 1 500px">
      <label>3D Preview</label>
      <div id="view3d"></div>
    </div>
  </div>
</div>

<script>
  const dz1=document.getElementById('dz1'); const dz2=document.getElementById('dz2');
  const f1=document.getElementById('f1'); const f2=document.getElementById('f2');
  const go=document.getElementById('go'); const resetBtn=document.getElementById('reset');
  const ref=document.getElementById('ref'); const thumbs=document.getElementById('thumbs');
  const state={src1:null, refs:[], active:0};

  function readFile(file){return new Promise((res,rej)=>{const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file);});}
  function setupDrop(el,cb){ el.addEventListener('dragover',e=>{e.preventDefault(); el.classList.add('drag');}); el.addEventListener('dragleave',()=>el.classList.remove('drag')); el.addEventListener('drop',async e=>{e.preventDefault(); el.classList.remove('drag'); const list=e.dataTransfer.files||[]; await cb(list);}); }

  setupDrop(dz1, async (files)=>{ const f=files[0]; if(f&&f.type.startsWith('image/')){ state.src1=await readFile(f);} go.disabled=!(state.src1&&state.refs.length); });
  setupDrop(dz2, async (files)=>{ for(const f of files){ if(f.type?.startsWith('image/')) state.refs.push(await readFile(f)); } if(state.refs.length){ state.active=state.refs.length-1; ref.src=state.refs[state.active]; } renderThumbs(); go.disabled=!(state.src1&&state.refs.length); });

  f1.addEventListener('change', async()=>{ if(f1.files[0]){ state.src1=await readFile(f1.files[0]); go.disabled=!(state.src1&&state.refs.length);} });
  f2.addEventListener('change', async()=>{ if(!f2.files.length) return; for(const file of f2.files){ if(file.type.startsWith('image/')){ state.refs.push(await readFile(file)); } } state.active=state.refs.length-1; ref.src=state.refs[state.active]; renderThumbs(); go.disabled=!(state.src1&&state.refs.length); });
  resetBtn.addEventListener('click', ()=>location.reload());

  function renderThumbs(){ thumbs.innerHTML=''; state.refs.forEach((u,i)=>{ const im=document.createElement('img'); im.src=u; im.title=`Reference ${i+1}`; if(i===state.active) im.classList.add('active'); im.onclick=()=>{ state.active=i; ref.src=state.refs[state.active]; updatePlane(); renderThumbs(); }; thumbs.appendChild(im); }); }

  // Three.js minimal viewer
  let renderer, scene, camera, controls, cloud, plane;
  function init3D(){ const host=document.getElementById('view3d'); const w=host.clientWidth,h=host.clientHeight; renderer=new THREE.WebGLRenderer({antialias:true}); renderer.setSize(w,h); host.innerHTML=''; host.appendChild(renderer.domElement); scene=new THREE.Scene(); scene.background=new THREE.Color(0x000000); camera=new THREE.PerspectiveCamera(50,w/h,1,5000); camera.position.set(0,180,800); controls=new THREE.OrbitControls(camera,renderer.domElement); scene.add(new THREE.AmbientLight(0xffffff,0.7)); const d=new THREE.DirectionalLight(0xffffff,0.6); d.position.set(1,1,1); scene.add(d); const animate=()=>{requestAnimationFrame(animate); controls.update(); renderer.render(scene,camera);}; animate(); }

  function makeCloud(points){ const g=new THREE.BufferGeometry(); const pos=new Float32Array(points.length*3); const col=new Float32Array(points.length*3); for(let i=0;i<points.length;i++){ const p=points[i]; pos[i*3]=p.x; pos[i*3+1]=p.y; pos[i*3+2]=p.z; col[i*3]=p.r/255; col[i*3+1]=p.g/255; col[i*3+2]=p.b/255; } g.setAttribute('position', new THREE.BufferAttribute(pos,3)); g.setAttribute('color', new THREE.BufferAttribute(col,3)); return new THREE.Points(g, new THREE.PointsMaterial({size:2,vertexColors:true})); }

  function imageToPoints(url, step=6, zScale=0.7){ return new Promise(res=>{ const img=new Image(); img.onload=()=>{ const c=document.createElement('canvas'), x=c.getContext('2d'); const w=img.width,h=img.height,max=960,s=Math.min(1,max/Math.max(w,h)); const W=Math.round(w*s),H=Math.round(h*s); c.width=W;c.height=H; x.drawImage(img,0,0,W,H); const d=x.getImageData(0,0,W,H).data; const pts=[]; for(let y=0;y<H;y+=step){ for(let x0=0;x0<W;x0+=step){ const i=(y*W+x0)*4; const r=d[i],g=d[i+1],b=d[i+2]; const br=(0.299*r+0.587*g+0.114*b)/255; const X=x0-W/2, Y=H/2-y, Z=(br-0.5)*(W+H)/2*zScale; pts.push({x:X,y:Y,z:Z,r,g,b}); }} res(pts); }; img.src=url; }); }

  async function build(){ if(!state.src1) return; const pts=await imageToPoints(state.src1,5,0.8); if(cloud) scene.remove(cloud); cloud=makeCloud(pts); scene.add(cloud); updatePlane(); }
  function updatePlane(){ if(plane){ scene.remove(plane); plane.geometry.dispose(); plane.material.dispose(); } if(state.refs.length){ const tex=new THREE.TextureLoader().load(state.refs[state.active]); plane=new THREE.Mesh(new THREE.PlaneGeometry(600,360), new THREE.MeshBasicMaterial({map:tex, side:THREE.DoubleSide})); plane.position.set(-380,60,-80); plane.rotation.y=-0.2; scene.add(plane);} }

  document.getElementById('go').addEventListener('click', build);
  window.addEventListener('load', init3D);
</script>
</body>
</html>
